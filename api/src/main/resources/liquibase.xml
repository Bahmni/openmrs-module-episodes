<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    <changeSet author="rnjn/vinay" id="20160208-1819">
        <createTable tableName="episode">
            <column autoIncrement="true" name="episode_id" type="int">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="true"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="DATETIME"/>
            <column defaultValueBoolean="false" name="voided" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
            <column name="date_voided" type="DATETIME"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="uuid" type="char(38)" >
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="rnjn/vinay" id="20160208-1820">
        <createTable tableName="episode_encounter">
            <column name="episode_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="encounter_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="episode_encounter_episode_id"
                                 baseTableName="episode_encounter" baseColumnNames="episode_id"
                                 referencedTableName="episode" referencedColumnNames="episode_id"
                />
        <addForeignKeyConstraint constraintName="episode_encounter_encounter_id"
                                 baseTableName="episode_encounter" baseColumnNames="encounter_id"
                                 referencedTableName="encounter" referencedColumnNames="encounter_id"
                />

    </changeSet>
    <changeSet author="rnjn/vinay" id="20160208-1821">
        <createTable tableName="episode_patient_program">
            <column name="episode_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="patient_program_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="episode_patient_program_episode_id"
                                 baseTableName="episode_patient_program" baseColumnNames="episode_id"
                                 referencedTableName="episode" referencedColumnNames="episode_id"
                />
        <addForeignKeyConstraint constraintName="episode_patient_program_patient_program_id"
                                 baseTableName="episode_patient_program" baseColumnNames="patient_program_id"
                                 referencedTableName="patient_program" referencedColumnNames="patient_program_id"
                />
    </changeSet>
    <changeSet author="rnjn/vinay" id="20160208-1822">
        <createIndex indexName="episode_encounter_episode_index" tableName="episode_encounter" unique="false">
            <column name="episode_id"/>
        </createIndex>
        <createIndex indexName="episode_patient_program_episode_index" tableName="episode_patient_program" unique="false">
            <column name="episode_id"/>
        </createIndex>
    </changeSet>

    <changeSet author="angshu" id="EOC-20251109-1423">
        <createTable tableName="episode_reason">
            <column autoIncrement="true" name="episode_reason_id" type="int">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="episode_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="use_concept_id" type="int">
                <constraints nullable="true"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="true"/>
            </column>
            <column name="value_concept_id" type="int"/>
            <column name="value_reference" type="varchar(255)"/>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="uuid" type="char(38)" >
                <constraints nullable="false"/>
            </column>
            <column name="voided" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
            <column name="void_reason" type="varchar(255)"/>
            <column name="date_voided" type="DATETIME"/>
        </createTable>
        <modifySql dbms="mssql">
            <replace replace="CHAR(38)" with="UNIQUEIDENTIFIER DEFAULT NEWSEQUENTIALID()"/>
        </modifySql>
    </changeSet>
    <changeSet id="EOC-20251109-1437" author="angshu">
        <addForeignKeyConstraint constraintName="episode_reason_creator_fk"
                                 baseTableName="episode_reason" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id" />
        <addForeignKeyConstraint constraintName="episode_reason_episode_id_fk"
                                 baseTableName="episode_reason" baseColumnNames="episode_id"
                                 referencedTableName="episode" referencedColumnNames="episode_id"
        />
        <addForeignKeyConstraint constraintName="episode_encounter_use_concept_id_fk"
                                 baseTableName="episode_reason" baseColumnNames="use_concept_id"
                                 referencedTableName="concept" referencedColumnNames="concept_id"
        />
        <addForeignKeyConstraint constraintName="episode_encounter_value_concept_id_fk"
                                 baseTableName="episode_reason" baseColumnNames="value_concept_id"
                                 referencedTableName="concept" referencedColumnNames="concept_id"
        />
        <addForeignKeyConstraint constraintName="episode_reason_voided_by_fk"
                                 baseTableName="episode_reason" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"
        />
    </changeSet>


    <changeSet id="EOC-20251009-1432" author="angshu" dbms="mysql,mariadb,postgresql">
        <preConditions onFail="MARK_RAN" onError="WARN">
            <tableExists tableName="episode"/>
            <not>
                <columnExists tableName="episode" columnName="patient_id"/>
            </not>
        </preConditions>
        <addColumn tableName="episode">
            <column name="patient_id" type="INT">
                <constraints nullable="true"/>
            </column>
            <column name="status" type="varchar(20)">
                <constraints nullable="true"/>
            </column>
            <column name="date_started" type="DATETIME" valueComputed="date_created">
                <constraints nullable="true"/>
            </column>
            <column name="date_ended" type="DATETIME">
                <constraints nullable="true"/>
            </column>
            <column name="concept_id" type="int">
                <constraints nullable="true"/>
            </column>
            <column name="care_manager" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="episode_patient_fk"
                                 baseTableName="episode" baseColumnNames="patient_id"
                                 referencedTableName="patient" referencedColumnNames="patient_id"/>
        <addForeignKeyConstraint constraintName="episode_type_concept_id_fk"
                                 baseTableName="episode" baseColumnNames="concept_id"
                                 referencedTableName="concept" referencedColumnNames="concept_id"
        />
        <addForeignKeyConstraint constraintName="episode_care_manager_id_fk"
                                 baseTableName="episode" baseColumnNames="care_manager"
                                 referencedTableName="users" referencedColumnNames="user_id"
        />
    </changeSet>
    <changeSet id="EOC-20251009-1651" author="angshu">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="episode_attribute_type" />
            </not>
        </preConditions>
        <createTable tableName="episode_attribute_type">
            <column name="episode_attribute_type_id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="name" type="varchar(100)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="datatype" type="varchar(255)" />
            <column name="datatype_config" type="text" />
            <column name="preferred_handler" type="varchar(255)" />
            <column name="handler_config" type="text" />
            <column name="min_occurs" type="int">
                <constraints nullable="false" />
            </column>
            <column name="max_occurs" type="int"></column>
            <column name="creator" type="int">
                <constraints nullable="false" />
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="changed_by" type="int" />
            <column name="date_changed" type="datetime" />
            <column name="retired" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
            <column name="retired_by" type="int" />
            <column name="date_retired" type="datetime" />
            <column name="retire_reason" type="varchar(255)" defaultValue="null" />
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true" />
            </column>
        </createTable>
        <modifySql dbms="mssql">
            <replace replace="CHAR(38)" with="UNIQUEIDENTIFIER DEFAULT NEWSEQUENTIALID()"/>
        </modifySql>
    </changeSet>
    <changeSet id="EOC-20251009-1655" author="angshu">
        <addForeignKeyConstraint constraintName="episode_attribute_type_creator_fk"
                                 baseTableName="episode_attribute_type" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id" />
        <addForeignKeyConstraint constraintName="episode_attribute_type_changed_by_fk"
                                 baseTableName="episode_attribute_type" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id" />
        <addForeignKeyConstraint constraintName="episode_attribute_type_retired_by_fk"
                                 baseTableName="episode_attribute_type" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id" />
    </changeSet>
    <changeSet id="EOC-20251009-1653" author="angshu">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="episode_attribute" />
            </not>
        </preConditions>
        <createTable tableName="episode_attribute">
            <column name="episode_attribute_id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="episode_id" type="int"><constraints nullable="false" /></column>
            <column name="attribute_type_id" type="int"><constraints nullable="false" /></column>
            <column name="value_reference" type="text"><constraints nullable="false" /></column>
            <column name="creator" type="int"><constraints nullable="false"/></column>
            <column name="date_created" type="datetime"><constraints nullable="false"/></column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime" />
            <column name="voided" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int" />
            <column name="date_voided" type="datetime" />
            <column name="void_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)"><constraints nullable="false" unique="true" /></column>
        </createTable>
        <modifySql dbms="mssql">
            <replace replace="CHAR(38)" with="UNIQUEIDENTIFIER DEFAULT NEWSEQUENTIALID()"/>
        </modifySql>
    </changeSet>
    <changeSet author="angshu" id="20251009-1657">
        <addForeignKeyConstraint constraintName="episode_attribute_attribute_type_id_fk"
                                 baseTableName="episode_attribute" baseColumnNames="attribute_type_id"
                                 referencedTableName="episode_attribute_type" referencedColumnNames="episode_attribute_type_id"/>
        <addForeignKeyConstraint constraintName="episode_attribute_episode_id_fk"
                                 baseTableName="episode_attribute" baseColumnNames="episode_id"
                                 referencedTableName="episode" referencedColumnNames="episode_id" />
        <addForeignKeyConstraint constraintName="episode_attribute_creator_fk"
                                 baseTableName="episode_attribute" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id" />
        <addForeignKeyConstraint constraintName="episode_attribute_changed_by_fk"
                                 baseTableName="episode_attribute" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id" />
        <addForeignKeyConstraint constraintName="episode_attribute_voided_by_fk"
                                 baseTableName="episode_attribute" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id" />
    </changeSet>

    <changeSet id="EOC-20251014-1953" author="angshu" dbms="mysql,mariadb,postgresql">
        <createTable tableName="episode_visit">
            <column name="episode_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="visit_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="episode_visit_episode_id_fk"
                                 baseTableName="episode_visit" baseColumnNames="episode_id"
                                 referencedTableName="episode" referencedColumnNames="episode_id"
        />
        <addForeignKeyConstraint constraintName="episode_visit_visit_id_fk"
                                 baseTableName="episode_visit" baseColumnNames="visit_id"
                                 referencedTableName="visit" referencedColumnNames="visit_id"
        />
    </changeSet>
    <changeSet id="EOC-20251014-1957" author="angshu" dbms="mysql,mariadb,postgresql">
        <createTable tableName="episode_status_history">
            <column autoIncrement="true" name="episode_status_history_id" type="int">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="episode_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="date_started" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="date_ended" type="DATETIME">
                <constraints nullable="true"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="true"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="uuid" type="char(38)" >
                <constraints nullable="false"/>
            </column>
        </createTable>
        <modifySql dbms="mssql">
            <replace replace="CHAR(38)" with="UNIQUEIDENTIFIER DEFAULT NEWSEQUENTIALID()"/>
        </modifySql>
    </changeSet>
    <changeSet id="EOC-20251014-2005" author="angshu">
        <addForeignKeyConstraint constraintName="episode_status_history_episode_id_fk"
                                 baseTableName="episode_status_history" baseColumnNames="episode_id"
                                 referencedTableName="episode" referencedColumnNames="episode_id"
        />
        <addForeignKeyConstraint constraintName="episode_status_history_creator_fk"
                                 baseTableName="episode_status_history" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id" />
    </changeSet>

</databaseChangeLog>